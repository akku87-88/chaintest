<!-- main-content -->
<div class="main-content app-content" [ngClass]="{'bdd': build.bdd}" *ngIf="build">
  <div class="page-header">
    <div class="container">
      <div class="d-flex justify-content-between">
        <h4>Build {{build.id}}</h4>
        <div>
          <button type="button" class="btn btn-outline-light btn-sm" (click)="toggleDisplayCharts()">
            <i class="bi bi-toggle"></i> Toggle Charts
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container" *ngIf="build">

    <!-- charts -->
    <div class="row" *ngIf="displayCharts">
      <div class="col-4" *ngIf="buildDepth >= 1">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="mb-0">Features</h6>
          </div>
          <div class="card-body py-0">
            <div class="mx-auto" style="width: 150px;max-height: 150px;">
              <canvas baseChart [type]="chartType" [data]="depth0" [options]="getOptions(0)"></canvas>
            </div>
          </div>
          <div class="card-footer smaller">
            {{depth0.datasets[0].data[0]}} Passed,
            {{depth0.datasets[0].data[1]}} Failed,
            {{depth0.datasets[0].data[2]}} Skipped
          </div>
        </div>
      </div>
      <div class="col-4" *ngIf="buildDepth >= 2">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="mb-0">Scenarios</h6>
          </div>
          <div class="card-body py-0">
            <div class="mx-auto" style="width: 150px;max-height: 150px;">
              <canvas baseChart [type]="chartType" [data]="depth1" [options]="getOptions(1)"></canvas>
            </div>
          </div>
          <div class="card-footer smaller">
            {{depth1.datasets[0].data[0]}} Passed,
            {{depth1.datasets[0].data[1]}} Failed,
            {{depth1.datasets[0].data[2]}} Skipped
          </div>
        </div>
      </div>
      <div class="col-4" *ngIf="buildDepth >= 3">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="mb-0">Steps</h6>
          </div>
          <div class="card-body py-0">
            <div class="mx-auto" style="width: 150px;max-height: 150px;">
              <canvas baseChart [type]="chartType" [data]="depth2" [options]="getOptions(2)"></canvas>
            </div>
          </div>
          <div class="card-footer smaller">
            {{depth2.datasets[0].data[0]}} Passed,
            {{depth2.datasets[0].data[1]}} Failed,
            {{depth2.datasets[0].data[2]}} Skipped
          </div>
        </div>
      </div>
    </div>
    <!-- /charts -->

    <div class="row">
      <div *ngIf="page">
        <div class="mt-3 mb-3 d-flex justify-content-between">
          <div>
            <button type="button" class="btn btn-outline-light btn-sm">
                <i class="bi bi-funnel"></i> Add Filters
            </button>
          </div>
          <div>
            <span class="small">Showing {{page.content.length}} of {{build.buildstats[0].total}} tests</span>
            <button type="button" class="btn btn-outline-light btn-sm ms-2" 
              *ngIf="page.totalElements < build.buildstats[0].total"
              (click)="findAllTests()">
              Show all
            </button>
            <button type="button" class="btn btn-outline-light btn-sm ms-2" 
              *ngIf="result != 'FAILED'"
              (click)="result = 'FAILED'; findTests()">
              Show failed only
            </button>
          </div>
        </div>

        <div class="ms-1 mt-3" *ngIf="result == 'FAILED' && !page.content.length">
          <p>All tests passed! <span class="pointer text-primary fw-semibold" (click)="findAllTests()">Show all</span> tests in this build.</p>
        </div>

        <ng-container>
          <div class="row mb-5" *ngFor="let test of page.content">
            <div class="col-4">
              <h5 class="mb-3 testname" [ngClass]="test.result.toLowerCase()">{{test.name}}</h5>
              <div class="">
                <span class="badge bg-outline-light"><i class="bi bi-hourglass me-1"></i>{{test.durationMs | prettyTime}}</span>
                <span class="badge bg-outline-light text-bg-info-light ms-1"><i class="bi bi-clock me-1"></i>{{test.startedAt | date:'yyyy-MM-dd h:m:s a'}}</span>
                <span class="badge bg-outline-light text-bg-danger-light ms-1"><i class="bi bi-clock me-1"></i>{{test.endedAt | date:'yyyy-MM-dd h:m:s a'}}</span>
              </div>
              <div class="mt-2" *ngIf="test.tags">
                <span class="badge rounded-pill text-bg-secondary me-1" *ngFor="let tag of test.tags">{{tag.name}}</span>
              </div>
              <div class="mt-2 ms-1 d-flex flex-row" *ngIf="test.history && test.history.content.length">
                <span class="me-2">History <i class="bi bi-chevron-right"></i></span>
                <a class="status-bar" 
                  *ngFor="let history of test.history.content.reverse()"
                  [ngClass]="{'status-success': history.result.toString() == 'PASSED', 'status-failure': history.result.toString() != 'PASSED'}"
                  [routerLink]="['projects', build.projectId, 'builds', history.buildId]"
                  ngbTooltip="{{history.result}}, {{history.startedAt | timeago}}"
                  tooltipClass="text-sm">
                </a>
              </div>
            </div>
            <div class="col-8">
              <div class="card mb-1" *ngFor="let child of test.children">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between">
                    <div>
                      <i class="bi bi-check-circle-fill text-success" *ngIf="child.result.toString() == 'PASSED'"></i>
                      <i class="bi bi-exclamation-octagon-fill text-danger" *ngIf="child.result.toString() != 'PASSED'"></i>
                      <span class="ms-2">{{child.name}}</span>
                    </div>
                    <div>
                      <span class="tags" *ngIf="child.tags && child.tags.length">
                        <span class="badge rounded-pill text-bg-secondary me-1" *ngFor="let tag of child.tags">{{tag.name}}</span> &middot;
                      </span>
                      <span class="badge bg-light">{{child.durationMs | prettyTime}}</span>
                    </div>
                  </div>
                  <div class="mt-2" *ngIf="child.error">
                    <pre>{{child.error}}</pre>
                  </div>
                  <div class="pt-1 mt-3 border-top" *ngIf="child.children && child.children.length">
                    <div [ngClass]="{'mt-1': build.bdd, 'mt-3': !build.bdd}" *ngFor="let leaf of child.children">
                      <div class="d-flex justify-content-between">
                        <div>
                          <i class="bi bi-check-circle-fill text-success" *ngIf="leaf.result.toString() == 'PASSED'"></i>
                          <i class="bi bi-exclamation-octagon-fill text-danger" *ngIf="leaf.result.toString() != 'PASSED'"></i>
                          <span class="ms-2">{{leaf.name}}</span>
                        </div>
                        <div>
                          <span class="tags" *ngIf="leaf.tags && leaf.tags.length">
                            <span class="badge rounded-pill text-bg-secondary me-1" *ngFor="let tag of leaf.tags">{{tag.name}}</span> &middot;
                          </span>
                          <span class="badge bg-light">{{leaf.durationMs | prettyTime}}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <div class="my-5 d-flex justify-content-center" *ngIf="page.content.length">
          <button type="button" class="btn btn-outline-primary" 
          (click)="loadNextPage()"
          [ngClass]="{'d-none': page.last}"
          [disabled]="page.last">Load more tests</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /main-content -->
